## Использование механизма аутентификации с помощью стороннего сервиса

### Шаг 1: Добавление зависимостей в проект

Чтобы поддержать аутентификацию OAuth 2.0 в Spring Boot приложении, необходимо добавить библиотеки, которые обеспечивают интеграцию с OAuth 2.0 и OpenID Connect. Это достигается за счет добавления `spring-boot-starter-oauth2-client`. Эта стартер-зависимость включает в себя все необходимое для работы с OAuth 2.0, включая поддержку для обмена токенами, управления токенами доступа и их обновления. Она также поддерживает различные провайдеры OAuth 2.0, включая Google, Facebook, и другие. При добавлении зависимости, Spring Boot автоматически конфигурирует необходимые бины и пути, которые управляют процессом аутентификации.

### Шаг 2: Конфигурация приложения

Необходимо настроить `application.yml` или `application.properties` для указания параметров OAuth2, предоставленных Google, таких как client ID и client secret, а также указать URI для перенаправления после аутентификации. Эти параметры используются Spring Security для построения URL, который направит пользователя на страницу аутентификации Google. Также стоит указать области доступа (scopes), которые определяют уровень доступа к информации пользователя, необходимого приложению. Конфигурация также может включать настройки для разных сред, например, разработки и продакшена, предоставляя различные ключи и секреты для каждой среды.

### Шаг 3: Изменение SecurityConfig

В классе `SecurityConfig`, который управляет настройками безопасности в Spring Boot, добавляется конфигурация, которая указывает Spring Security использовать OAuth2 для аутентификации. Это включает в себя настройку аутентификации через OAuth2 логин, позволяя Spring Security автоматически обрабатывать процесс аутентификации. Также настраиваются обработчики, которые управляют успешным входом пользователя и ошибками аутентификации. Это позволяет приложению адаптироваться к результатам аутентификации и соответственно реагировать.

### Шаг 4: Реализация OAuth2UserService

`OAuth2UserService` — это интерфейс, который загружает данные пользователя после его аутентификации. Реализация этого сервиса позволяет извлекать необходимые данные пользователя из информации, предоставленной Google после аутентификации. Это включает в себя имя пользователя, его email и другую информацию, которую можно использовать для создания или обновления учетной записи пользователя в вашей системе. Эти данные могут также использоваться для создания объекта `Authentication`, который представляет аутентифицированного пользователя в системе.

### Шаг 5: Генерация и возврат JWT

После успешной аутентификации пользователя через Google, система должна сгенерировать JWT (JSON Web Token), который будет использоваться для последующих запросов для аутентификации без повторного входа в систему. `JwtTokenProvider`, который уже реализован в вашем приложении, может использоваться для этого. Токен содержит зашифрованную информацию о пользователе и срок его действия. При каждом запросе токен будет проверяться для подтверждения его валидности, позволяя пользователю доступ к защищенным ресурсам без необходимости повторного входа.

Эти полный цикл аутентификации пользователя через Google в вашем Spring Boot приложении, начиная от аутентификации и заканчивая авторизацией запросов на основе валидного JWT.


## Технология работы

### Шаг 1: Перенаправление пользователя на страницу аутентификации Google

Процесс OAuth 2.0 начинается с перенаправления пользователя на страницу аутентификации Google. Это происходит, когда пользователь выбирает опцию входа через Google на вашем сайте. Spring Security, используя конфигурацию, указанную в `application.yml`, генерирует URL, который включает в себя идентификатор клиента (client ID), секрет клиента (client secret), запрашиваемые области доступа (scopes), и URI перенаправления обратно на ваш сайт после аутентификации. URL также содержит параметры, необходимые для определения того, какие данные пользователя ваше приложение хочет получить. Пользователь переходит по этому URL, попадая на страницу входа Google, где он вводит свои учетные данные.

### Шаг 2: Аутентификация пользователя и согласие на предоставление данных

После ввода учетных данных, Google аутентифицирует пользователя и запрашивает его согласие на предоставление доступа к его данным приложению, если это первая авторизация через данное приложение. Этот шаг критичен, так как без согласия пользователя, приложение не получит необходимый доступ. Если пользователь соглашается, Google генерирует код авторизации, который отправляется обратно на URI перенаправления, указанный в начальном запросе.

### Шаг 3: Обмен кода авторизации на токен доступа

Когда пользователь успешно аутентифицирован, и если он подтвердил предоставление доступа к своим данным, Google перенаправляет его обратно на ваш сайт с кодом авторизации в параметрах URL. Ваше приложение, получив код, отправляет его обратно в Google вместе с client secret для обмена на токен доступа. Это обеспечивает безопасность процесса, так как код авторизации сам по себе не дает доступ к информации пользователя и должен быть обменен на токен доступа в течение короткого времени.

### Шаг 4: Получение токена доступа и информации о пользователе

После успешного обмена кода на токен доступа, приложение получает токен доступа от Google. Этот токен используется для доступа к API Google для извлечения информации о пользователе, такой как имя, email и другие данные, которые были запрошены и одобрены пользователем. Токен доступа обеспечивает временный, безопасный способ для приложения запросить пользовательские данные без необходимости повторного ввода учетных данных пользователя.

### Шаг 5: Создание и отправка JWT пользователю

Получив данные пользователя от Google, ваше приложение может теперь создать новую учетную запись пользователя или обновить существующую. В зависимости от результатов запроса, приложение генерирует JWT, который включает в себя идентификатор пользователя и другие важные утверждения (claims), такие как роли и права доступа. Этот токен будет использоваться для аутентификации и авторизации пользовательских запросов к вашему приложению без необходимости повторной аутентификации через Google. JWT отправляется обратно пользователю, обычно через HTTP-ответ, и сохраняется на клиенте (например, в localStorage в браузере).

Этот процесс обеспечивает безопасную и удобную аутентификацию пользователя через Google, используя стандарт OAuth 2.0. Он минимизирует риски безопасности, связанные с хранением и управлением учетными данными, и предоставляет эффективный способ управления доступом к ресурсам приложения.


